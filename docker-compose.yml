version: '2' 

networks:
  efk_hostnet:
    external: true

services:
  
  db:
    image: mongo
    volumes:
      - "/var/mongo-data:/data/db"
      - "/var/mongo-backup:/opt"
      - "/var/icoworld/docker-entrypoint:/docker-entrypoint-initdb.d/"
    env_file:
      - "/var/icoworld/mongo.env/"
    restart: on-failure
    container_name: database
    logging:
      driver: "fluentd"
      options:
        fluentd-address: 172.18.0.10:24224
        tag: mongo.log
    networks:
      efk_hostnet:
        ipv4_address: 172.18.0.112
    #command: mongod --bind_ip 0.0.0.0
  
  app:
      build: .
      env_file:
        - "/var/icoworld/app.env"
      image: ico/backend:staging-$BUILD_ID
      container_name: backend-$BUILD_ID
      volumes:
        - "/var/static/images:/app/static/images/:rw"
      networks:
        efk_hostnet:
          ipv4_address: 172.18.0.113 
      ports:
        - "3000:3000"
      logging:
        driver: "fluentd"
        options:
          fluentd-address: 172.18.0.10:24224
          tag: backend.log
